-- Add the new PREVIOUS_STATUS_CODE column
ALTER TABLE STUDY_ONHOLD ADD COLUMN PREVIOUS_STATUS_CODE VARCHAR(200);

-- Populate the PREVIOUS_STATUS_CODE column ith the latest status for on-hold studies
UPDATE STUDY_ONHOLD SO
SET PREVIOUS_STATUS_CODE = (SELECT STATUS_CODE 
FROM DOCUMENT_WORKFLOW_STATUS DWS1, 
     (SELECT STUDY_PROTOCOL_IDENTIFIER, MAX(STATUS_DATE_RANGE_LOW) AS MAX_DATE FROM DOCUMENT_WORKFLOW_STATUS GROUP BY STUDY_PROTOCOL_IDENTIFIER) DWS2
WHERE DWS1.STUDY_PROTOCOL_IDENTIFIER = DWS2.STUDY_PROTOCOL_IDENTIFIER AND DWS1.STATUS_DATE_RANGE_LOW = DWS2.MAX_DATE AND DWS1.STUDY_PROTOCOL_IDENTIFIER = SO.STUDY_PROTOCOL_IDENTIFIER)
WHERE OFFHOLD_DATE IS NULL;

-- Add the on-hold processing statuses for on-hold studies
INSERT INTO DOCUMENT_WORKFLOW_STATUS (IDENTIFIER, STATUS_CODE, COMMENT_TEXT, STATUS_DATE_RANGE_LOW, STUDY_PROTOCOL_IDENTIFIER, DATE_LAST_CREATED, USER_LAST_CREATED_ID)
(SELECT NEXTVAL('HIBERNATE_SEQUENCE'), 'ON_HOLD', ONHOLD_REASON_TEXT, ONHOLD_DATE, STUDY_PROTOCOL_IDENTIFIER, DATE_LAST_CREATED, USER_LAST_CREATED_ID
FROM STUDY_ONHOLD WHERE OFFHOLD_DATE IS NULL);

-- Update the on-hold status dates if the latest previus status was changed after the on-hold date
UPDATE DOCUMENT_WORKFLOW_STATUS DWS1
SET STATUS_DATE_RANGE_LOW = (SELECT MAX(STATUS_DATE_RANGE_LOW) + '1 second' FROM DOCUMENT_WORKFLOW_STATUS DWS2 WHERE DWS1.STUDY_PROTOCOL_IDENTIFIER = DWS2.STUDY_PROTOCOL_IDENTIFIER)
WHERE STATUS_CODE = 'ON_HOLD' AND 
STATUS_DATE_RANGE_LOW < (SELECT MAX(STATUS_DATE_RANGE_LOW) FROM DOCUMENT_WORKFLOW_STATUS DWS2 WHERE DWS1.STUDY_PROTOCOL_IDENTIFIER = DWS2.STUDY_PROTOCOL_IDENTIFIER);